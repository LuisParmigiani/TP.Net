@page "/MenuAlumno/{AlumnoId}"

@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components
@using System.Net.Http.Json
@using DTOs


@inject IHttpClientFactory ClientFactory
@inject NavigationManager Navigation


<h3 style="font-family:Segoe UI, Roboto, Arial; color:#2c3e50; background:linear-gradient(90deg,#eef2f6,#ffffff); padding:12px 16px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08); margin-bottom:12px; text-align:center;">MenuAlumno</h3>

@code {
    [Parameter]
    public string AlumnoId { get; set; }

    [Parameter]
    public string? Page { get; set; }

    private int materiaId;

    public string mensaje;

    private List<EstadoAcademico>? estadoAcedemicos;

    private List<EstadoAcademico>? materiasList;

    private List<CursoWithEstado>? cursosList;

    private int? loadingCursoId;

    private string nuevaContrasena = string.Empty;
    private string confirmarContrasena = string.Empty;
    private bool isChangingPassword = false;

    private async Task EstadoAcademico()
    {
        try
        {
            var client = ClientFactory.CreateClient("API");
            if (int.TryParse(AlumnoId, out int id))
            {
                var estado = await client.GetFromJsonAsync<List<EstadoAcademico>>($"/inscripciones/estadoOfAlumno/{id}");
                if (estado != null)
                {
                    estadoAcedemicos = estado;
                }
                else
                {
                    Console.WriteLine("No se devolvieron materias desde la API.");
                    estadoAcedemicos = new List<EstadoAcademico>();
                }
            }
            
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Excepción al obtener las materias: {ex.Message}");
            estadoAcedemicos = new List<EstadoAcademico>();
        }

        StateHasChanged();
    }

    private async Task InscripcionMaterias()
    {
        try
        {
            var client = ClientFactory.CreateClient("API");
            var materias = await client.GetFromJsonAsync<List<EstadoAcademico>>($"/inscripciones/estadoOfAlumno/{AlumnoId}");
            if (materias != null)
            {
                materiasList = materias;
            }
            else
            {
                mensaje = ("No se devolvieron materias desde la API.");
                materiasList = new List<EstadoAcademico>();
            }

        }catch  (Exception ex)
        {
            mensaje =  ( $"Excepción al obtener las materias: {ex.Message}");
            materiasList = new List<EstadoAcademico>();
        }
    }

    public async Task  AnotarmeMateria(int materiaId)
    {
        try
        {
            var client = ClientFactory.CreateClient("API");
            var cursos = await client.GetFromJsonAsync<List<CursoWithEstado>>($"/cursos/ByMateria/{materiaId}");
            if (cursos != null)
            {
             
                cursosList = cursos;
          

            }
            else
            {
                mensaje = ("No se devolvieron materias desde la API.");
                cursosList = new List<CursoWithEstado>();

            }

        }
        catch (Exception ex)
        {
            mensaje = ($"Excepción al obtener las materias: {ex.Message}");
            cursosList = new List<CursoWithEstado>();
        }
        
        
    }

    public async Task AnotarmeCurso(int cursoId)
    {
        try
        {
            loadingCursoId = cursoId;
            StateHasChanged();

            var client = ClientFactory.CreateClient("API");
            var inscripcion = new InscripcionDTO
            {
                IdAlumno = int.Parse(AlumnoId),
                IdCurso = cursoId,
                Condicion= "cursando"
            };
            var response = await client.PostAsJsonAsync("/inscripciones", inscripcion);
            if (response.IsSuccessStatusCode)
            {
                mensaje = ("Inscripción realizada con éxito.");
                
            }
            else
            {
                mensaje = ($"Error al inscribirse: {(int)response.StatusCode} {response.ReasonPhrase}");
                Page = "3";
            }
            

        }
        catch (Exception ex)
        {
            mensaje = ($"Excepción al obtener las materias: {ex.Message}");
          
        }
        finally
        {
            loadingCursoId = null;
            StateHasChanged();
        }
        
        
    }

    private async Task CambiarContrasenaAsync()
    {
        if (string.IsNullOrWhiteSpace(nuevaContrasena))
        {
            mensaje = "Por favor ingrese la nueva contraseña.";
            return;
        }

        if (string.IsNullOrWhiteSpace(confirmarContrasena))
        {
            mensaje = "Por favor confirme la nueva contraseña.";
            return;
        }

        if (nuevaContrasena != confirmarContrasena)
        {
            mensaje = "Las contraseñas no coinciden.";
            return;
        }

        if (nuevaContrasena.Length < 6)
        {
            mensaje = "La contraseña debe tener al menos 6 caracteres.";
            return;
        }

        try
        {
            isChangingPassword = true;
            var client = ClientFactory.CreateClient("API");
            var response = await client.PutAsync($"/usuarios/cambioPass?idPersona={AlumnoId}&nuevaClave={Uri.EscapeDataString(nuevaContrasena)}", null);

            if (response.IsSuccessStatusCode)
            {
                mensaje = "Contraseña cambiada exitosamente.";
                Page = "0"; // Volver al menú principal
                nuevaContrasena = string.Empty;
                confirmarContrasena = string.Empty;
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                mensaje = $"Error al cambiar contraseña: {errorText}";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al cambiar contraseña: {ex.Message}";
        }
        finally
        {
            isChangingPassword = false;
        }
    }
}

@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert @(mensaje.StartsWith("Error") ? "alert-danger" : "alert-success")"
         style="background-color:@(mensaje.StartsWith("Error") ? "#f8d7da" : "#d4edda"); color:@(mensaje.StartsWith("Error") ? "#721c24" : "#155724"); padding:10px 14px; border-radius:6px; margin-bottom:14px; box-shadow:0 1px 2px rgba(0,0,0,0.04);">
        @mensaje
    </div>
}
@if (Page == "0"|| Page == null)
{
    
        <div style="display:flex; gap:12px; justify-content:center; margin-top:8px; flex-wrap:wrap;">
            <button @onclick='async () => { await InscripcionMaterias(); Page = "1"; }' style="background:#3182ce; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(49,130,206,0.18);">Inscripcion materias</button>
            <button @onclick='async () =>{await EstadoAcademico()  ;  Page = "2" ; }' style="background:#38a169; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(56,161,105,0.18);">Estado Academico</button>
            <button @onclick='() => Page = "4"' style="background:#ff9800; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(255,152,0,0.18);">Cambiar Contraseña</button>
        </div>
    
}
else if(Page == "1")
{
    <div style="max-width:900px; margin:14px auto; font-family:Segoe UI, Roboto, Arial;">
        <h3 style="color:#2c3e50; margin-bottom:10px;">Inscripcion materias</h3>
        @if (materiasList == null)
        {
            <p style="color:#6b7280;">Cargando Inscripcione...</p>
        }
        else if (materiasList.Count == 0)
        {
            <p style="color:#6b7280;">No se encontraron materias para poder inscribirse.</p>
        }
        else
        {
            <table style="width:100%; border-collapse:collapse; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
                <thead>
                    <tr style="background:#f7fafc;">
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e6e6e6;">Materias</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e6e6e6;">Inscribirme</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var mat in materiasList)
                    {
                        @if (mat.Nota == null)
                        {

                            <tr style="background:white;">
                                <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;">@mat.DescMateria</td>
                                <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;">
                                    <button @onclick=' async () => {await AnotarmeMateria(materiaId);materiaId = mat.IdMateria ; Page = "3"; }'
                                            style="background:#ff7b00; color:white; border:none; padding:8px 10px; border-radius:6px; cursor:pointer;">
                                        Anotarme
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
        <div style="margin-top:12px;">
            <button @onclick='() => Page = "0" ' style="background:#e2e8f0; color:#1f2937; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Volver</button>
        </div>
    </div>
}
else if(Page == "2")
{
    <div style="max-width:900px; margin:14px auto; font-family:Segoe UI, Roboto, Arial;">
        <h3 style="color:#2c3e50; margin-bottom:10px;">Estado Academico</h3>
        @if (estadoAcedemicos == null)
        {
            <p style="color:#6b7280;">Cargando materias...</p>
        }
        else if (estadoAcedemicos.Count == 0)
        {
            <p style="color:#6b7280;">No se encontraron materias.</p>
        }
        else
        {
            <table style="width:100%; border-collapse:collapse; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
                <thead>
                    <tr style="background:#f7fafc;">
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e6e6e6;">Materia</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e6e6e6;">Condicion</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e6e6e6;">Comision</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e6e6e6;">Año especialidad</th>

                    </tr>
                </thead>
                <tbody>
                    @foreach (var est in estadoAcedemicos)
                    {
                        <tr style="background:white;">
                            <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;">@est.DescMateria</td>
                            @if(est.Nota != null)
                            {
                                @if (est.Nota != 0)
                                {
                                    <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;">Nota final: @est.Nota</td>
                                }
                                else
                                {
                                    <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;">@est.Condicion</td>
                                }
                                <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;"> @est.IdComCursada</td>
                                <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;"> @est.AnioEspecialidadCursada</td>
                            }else
                            {
                                <td> No cursada  </td>
                                <td> -- </td>
                                <td> -- </td>
                            }


                        </tr>
                    }
                </tbody>
            </table>
        }

        <div style="margin-top:12px;">
            <button @onclick='() => Page = "0" ' style="background:#e2e8f0; color:#1f2937; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Volver</button>
        </div>
         
    </div>
}
else if (Page == "3") {
    <div style="max-width:900px; margin:14px auto; font-family:Segoe UI, Roboto, Arial;">
        <h3 style="color:#2c3e50; margin-bottom:10px;">Inscripcion Curso</h3>
        @if (cursosList == null)
        {
            <p style="color:#6b7280;">Cargando materias...</p>
        }
        else if (cursosList.Count == 0)
        {
            <p style="color:#6b7280;">No se encontraron materias.</p>
        }
        else
        {
            <table style="width:100%; border-collapse:collapse; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
                <thead>
                    <tr style="background:#f7fafc;">
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e6e6e6;">Curso</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e6e6e6;">Descripcion</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e6e6e6;">Anotarme</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cur in cursosList)
                    {
                        <tr style="background:white;">
                            <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;">@cur.Id</td>
                            <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;">@cur.Descripcion</td>
                            <td style="padding:10px 12px; border-bottom:1px solid #f1f1f1;">
                                    @if (cur.Estado)
                                    {
                                <button @onclick="() => AnotarmeCurso(cur.Id)"
                                        disabled="@(loadingCursoId == cur.Id)"
                                        style="background:@(loadingCursoId == cur.Id ? "#1e40af" : "#2b6cb0"); color:white; border:none; padding:8px 10px; border-radius:6px; cursor:@(loadingCursoId == cur.Id ? "not-allowed" : "pointer"); min-width:110px;">
                                        @if (loadingCursoId == cur.Id)
                                        {
                                            <span style="display:inline-flex; align-items:center; gap:8px;">
                                                <span>?</span>
                                                <span>Inscribiendo...</span>
                                            </span>
                                        }
                                        else
                                        {
                                            <span>Anotarme</span>
                                        }
                                </button>
                                    }else {
                                        <span>No hay mas cupo</span>
                                    }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <div style="margin-top:12px;">
            <button @onclick='async () =>{await InscripcionMaterias()  ;  Page = "1" ; }' style="background:#e2e8f0; color:#1f2937; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Volver</button>
        </div>
         
    </div>
}
else if (Page == "4")
{
    <div style="max-width:500px; margin:40px auto; font-family:Segoe UI, Roboto, Arial;">
        <div style="background:#ffffff; border-radius:10px; padding:32px; box-shadow:0 6px 18px rgba(15,23,42,0.06);">
            <h3 style="margin:0 0 24px 0; color:#2c3e50; text-align:center; font-size:20px; font-weight:600;">Cambiar Contraseña</h3>
            
            <div style="margin-bottom:16px;">
                <label style="display:block; margin-bottom:6px; color:#374151; font-weight:500; font-size:14px;">Nueva Contraseña:</label>
                <input type="password" @bind="nuevaContrasena" 
                       style="width:100%; padding:12px; border-radius:8px; border:1px solid #e5e7eb; outline:none; font-size:14px; box-sizing:border-box;" 
                       placeholder="Ingrese nueva contraseña" />
            </div>
            
            <div style="margin-bottom:24px;">
                <label style="display:block; margin-bottom:6px; color:#374151; font-weight:500; font-size:14px;">Confirmar Contraseña:</label>
                <input type="password" @bind="confirmarContrasena" 
                       style="width:100%; padding:12px; border-radius:8px; border:1px solid #e5e7eb; outline:none; font-size:14px; box-sizing:border-box;" 
                       placeholder="Confirme nueva contraseña" />
            </div>
            
            <div style="display:flex; gap:12px; justify-content:center;">
                <button style="background:#38a169; color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px;"
                        @onclick="CambiarContrasenaAsync" disabled="@isChangingPassword">
                    @if (isChangingPassword)
                    {
                        <span>Guardando...</span>
                    }
                    else
                    {
                        <span>Guardar</span>
                    }
                </button>
                <button style="background:#6b7280; color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px;"
                        @onclick='() => Page = "0"' disabled="@isChangingPassword">Cancelar</button>
            </div>
        </div>
    </div>
}
else
{
    <div style="text-align:center; margin-top:12px;">
        <button @onclick='() => Page = "0" ' style="background:#e2e8f0; color:#1f2937; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Volver</button>
    </div>
}